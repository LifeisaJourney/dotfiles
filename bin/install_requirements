#!/bin/bash


RUBY_VERSION='2.3.1'
NODE_VERSION='6.2.1'

RED='\033[0;31m'
PURPLE='\033[0;35m'
RESET='\033[0m'
script="$(basename "$0")"
script_dir="$( cd "$( dirname "$0" )" && pwd )"
requirements_dir="$( dirname "$script_dir" )/requirements"

log() {
  echo -e "${PURPLE}${script}:${RESET} $1"
}

fail() {
  echo -e "${RED}${script} failed:${RESET} $1" >&2
  exit 1
}

prompt() {
  echo -ne "${PURPLE}${script}:${RESET}"
  read -p " $1"
}

cd $script_dir

log "Removing rvm if you have it..."
prompt "Press enter to continue."

if which rvm > /dev/null; then
  log "rvm detected. Imploding..."
  rvm implode
  log "rvm imploded."
fi

cd $script_dir

log "Switch to OS specific script..."
prompt "Press enter to continue."

case "$(uname -s)" in

   Darwin)
     ## operating system is Mac OS
     chmod +x install_requirements_mac
     ./install_requirements_mac
     ;;

   Linux)
     ## operating system is Linux
     chmod +x install_requirements_linux
     ./install_requirements_linux
     ;;

   *)
     log 'Unsupported OS'
     ;;
esac

log "Switching back to non-OS specific script..."
log "Installing Ruby..."
prompt "Press enter to continue."
cd $requirements_dir

if rbenv global "$RUBY_VERSION" > /dev/null; then
  log "Ruby v$RUBY_VERSION already installed."
else
  log "activating rbenv..."
  eval "$(rbenv init -)" || fail "could not activate rbenv"
  source ~/.bashrc
  log "Installing Ruby v$RUBY_VERSION..."
  rbenv install "$RUBY_VERSION"
  log "Ruby v$RUBY_VERSION installed."
fi
rbenv global "$RUBY_VERSION"
rbenv rehash

log "Ruby v$RUBY_VERSION set as default version."
log "Installing bundler and gems..."
prompt "Press enter to continue."

rm Gemfile.lock > /dev/null # ensure previous installs don't interfere
gem install bundler
rbenv rehash
bundle install
rbenv rehash

log "Gems installed"
log "Installing Git completion..."
prompt "Press enter to continue."

git_url="https://raw.githubusercontent.com/git/git/master/contrib/completion"
curl "$git_url/git-completion.bash" > "$HOME/.git-completion.bash"
curl "$git_url/git-prompt.sh" > "$HOME/.git-prompt.sh"
log "Git completion installed."

log "Installing atom packages..."
prompt "Press enter to continue."

if which atom > /dev/null; then
  apm install --packages-file "../requirements/atom-packages.txt"
  log "Atom packages installed."
else
  fail "Please install atom and then install atom packages."
fi

log "Installing node packages..."
prompt "Press enter to continue."
npm install -g $(cat "node-packages.txt")
log "Node packages installed."

log "done."
