#!/bin/bash

REPO="$( cd "$( dirname "$0" )/.." && pwd )"
DOT="$REPO/dot"

install_dotfile() {
  source="$DOT/$1"
  target="$HOME/.$1"

  ensure_parent_dir "$target"
  remove_old_symlink "$target"
  copy_if_different "$source" "$target"
}

ensure_parent_dir() {
  mkdir -p "$(dirname "$1")"
}

remove_old_symlink() {
  # cleans up old a/A dotfiles architecture
  find "$1" -type l -delete
}

remove_broken_dotfiles_symlinks() {
  # cleans up old a/A dotfiles architecture
  find -L "$HOME" -maxdepth 1 -type l -exec rm {} +
}

copy_if_different() {
  source="$1"
  target="$2"
  if [[ ! -f "$target" ]] || [[ -n "$(diff "$source" "$target")" ]]; then
    cp -i "$source" "$target"
  fi
}

get_git_user_info() {
  git_name="$(git config --global user.name)"
  git_email="$(git config --global user.email)"
}

save_git_user_info() {
  [[ -n "$git_name" ]] && git config --global user.name "$git_name"
  [[ -n "$git_email" ]] && git config --global user.email "$git_email"
}

get_git_user_info

echo "$DOT" > "$HOME/.aa_config_dir"

install_dotfile "bash_profile"
install_dotfile "bashrc"
install_dotfile "eslintrc"
install_dotfile "gemrc"
install_dotfile "gitconfig"
install_dotfile "gitignore"
install_dotfile "pryrc"
install_dotfile "railsrc"
install_dotfile "rspec"
install_dotfile "rubocop.yml"
install_dotfile "sqliterc"
install_dotfile "atom/config.cson"

remove_broken_dotfiles_symlinks

save_git_user_info
